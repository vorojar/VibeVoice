<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen3-TTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#FAF8F5',
                        'cream-dark': '#F5F0E8',
                        'warm-gray': '#E8E4DD',
                        'charcoal': '#2D3748',
                        'accent': '#E07A5F',
                        'accent-dark': '#C96A52',
                        'text-primary': '#2D3748',
                        'text-secondary': '#4A5568',
                        'text-muted': '#718096',
                        'border-color': '#E2DED6',
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #FAF8F5;
            color: #2D3748;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #D4CFC6; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #B8B2A7; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #4A5568;
        }
        .nav-item:hover { background: #F5F0E8; color: #2D3748; }
        .nav-item.active { background: #E07A5F; color: white; }

        .voice-card {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #E2DED6;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .voice-card:hover { border-color: #E07A5F; background: #FDF8F6; }
        .voice-card.selected { border-color: #E07A5F; background: #FDF8F6; box-shadow: 0 0 0 2px rgba(224, 122, 95, 0.2); }

        .btn-primary {
            background: #E07A5F;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary:hover { background: #C96A52; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .input-field {
            width: 100%;
            padding: 10px 14px;
            background: white;
            border: 1px solid #E2DED6;
            border-radius: 8px;
            color: #2D3748;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .input-field:focus { outline: none; border-color: #E07A5F; }
        .input-field::placeholder { color: #A0AEC0; }

        textarea.input-field {
            resize: none;
            line-height: 1.8;
            font-size: 16px;
        }

        /* å¥å­è¿›åº¦æ ·å¼ */
        .sentence-pending {
            color: #2D3748;
        }
        .sentence-current {
            color: #E07A5F;
            background: #FEF3E2;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .sentence-done {
            color: #A0AEC0;
        }

        select.input-field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%234A5568' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        .audio-player {
            background: white;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid #E2DED6;
        }

        .play-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #E07A5F;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .play-btn:hover { background: #C96A52; transform: scale(1.05); }
        .play-btn svg { fill: white; }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: #E8E4DD;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        .progress-bar .progress {
            height: 100%;
            background: #E07A5F;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å½•éŸ³åŠ¨ç”» */
        .recording-indicator {
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
    </style>
</head>
<body>
    <div class="h-screen flex flex-col">
        <!-- é¡¶éƒ¨æ  -->
        <header class="h-14 bg-white border-b border-warm-gray flex items-center justify-between px-4 flex-shrink-0">
            <div class="flex items-center gap-3">
                <span class="text-xl">ğŸ™ï¸</span>
                <span class="font-bold text-lg text-charcoal">Qwen3-TTS</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleLanguage()" class="px-3 py-1.5 text-sm text-charcoal/60 hover:text-charcoal transition-colors">
                    <span id="lang-toggle">EN</span>
                </button>
                <button onclick="showPage('api')" class="px-3 py-1.5 text-sm text-charcoal/60 hover:text-charcoal transition-colors" data-i18n="nav.api">
                    API æ–‡æ¡£
                </button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="flex-1 flex overflow-hidden">
            <!-- å·¦ä¾§è¾¹æ  -->
            <aside class="w-56 bg-cream-dark border-r border-warm-gray flex flex-col flex-shrink-0">
                <!-- å¯¼èˆªèœå• -->
                <nav class="p-3 space-y-1">
                    <div class="nav-item active" onclick="switchMode('preset')" data-mode="preset">
                        <span>ğŸ¤</span>
                        <span data-i18n="nav.preset">é¢„è®¾è¯´è¯äºº</span>
                    </div>
                    <div class="nav-item" onclick="switchMode('clone')" data-mode="clone">
                        <span>ğŸ­</span>
                        <span data-i18n="nav.clone">è¯­éŸ³å…‹éš†</span>
                    </div>
                    <div class="nav-item" onclick="switchMode('design')" data-mode="design">
                        <span>âœ¨</span>
                        <span data-i18n="nav.design">å£°éŸ³è®¾è®¡</span>
                    </div>
                </nav>

                <!-- å£°éŸ³åº“ (ä»…å…‹éš†æ¨¡å¼æ˜¾ç¤º) -->
                <div id="voice-library-section" class="hidden flex-1 flex flex-col border-t border-warm-gray mt-2">
                    <div class="p-3 flex items-center justify-between">
                        <span class="text-sm font-medium text-charcoal/70" data-i18n="clone.voiceLibrary">å£°éŸ³åº“</span>
                        <button onclick="loadSavedVoices()" class="text-charcoal/40 hover:text-charcoal text-sm">â†»</button>
                    </div>
                    <div id="voice-list" class="flex-1 overflow-y-auto scrollbar-thin px-3 pb-3 space-y-2">
                        <!-- å£°éŸ³åˆ—è¡¨ -->
                    </div>
                </div>

                <!-- åº•éƒ¨ç‰ˆæœ¬ä¿¡æ¯ -->
                <div class="mt-auto p-3 border-t border-warm-gray text-xs text-charcoal/40">
                    Qwen3-TTS v1.0
                </div>
            </aside>

            <!-- ä¸­é—´å†…å®¹åŒº -->
            <main class="flex-1 flex flex-col bg-cream overflow-hidden">
                <!-- æ–‡æœ¬è¾“å…¥åŒº -->
                <div class="flex-1 p-6 flex flex-col">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-semibold text-charcoal" data-i18n="main.title">æ–‡å­—è½¬è¯­éŸ³</h2>
                        <span id="char-count" class="text-sm text-charcoal/50">0 <span data-i18n="stats.chars">å­—</span></span>
                    </div>
                    <textarea
                        id="text-input"
                        class="input-field flex-1"
                        data-i18n-placeholder="main.placeholder"
                        placeholder="åœ¨æ­¤è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬..."
                        oninput="updateCharCount()"
                    ></textarea>
                    <!-- ç”Ÿæˆè¿›åº¦è§†å›¾ (ç”Ÿæˆæ—¶æ˜¾ç¤º) -->
                    <div id="progress-view" class="hidden input-field flex-1 overflow-y-auto leading-relaxed"></div>

                    <!-- æ“ä½œæ  -->
                    <div class="flex items-center justify-between mt-4">
                        <div id="status-message" class="text-sm text-charcoal/60"></div>
                        <button id="generate-btn" onclick="generate()" class="btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <span data-i18n="btn.generate">ç”Ÿæˆè¯­éŸ³</span>
                        </button>
                    </div>
                </div>

                <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
                <div id="player-section" class="hidden border-t border-warm-gray p-4 bg-cream-dark">
                    <div class="audio-player">
                        <button id="play-btn" class="play-btn" onclick="togglePlay()">
                            <svg id="play-icon" width="20" height="20" viewBox="0 0 24 24">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                        <div class="flex-1">
                            <div class="progress-bar" onclick="seek(event)">
                                <div id="progress" class="progress"></div>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-charcoal/50">
                                <span id="current-time">0:00</span>
                                <span id="duration">0:00</span>
                            </div>
                        </div>
                        <div id="stats-display" class="text-right text-sm">
                            <div class="text-charcoal font-medium" id="stats-chars">-</div>
                            <div class="text-charcoal/50 text-xs" id="stats-speed">-</div>
                        </div>
                        <button id="download-btn" onclick="downloadAudio()" class="ml-4 p-3 bg-accent hover:bg-accent-dark text-white rounded-lg transition-colors" title="ä¸‹è½½">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                    </div>
                    <audio id="audio-element" class="hidden"></audio>
                </div>
            </main>

            <!-- å³ä¾§é…ç½®é¢æ¿ -->
            <aside class="w-72 bg-white border-l border-warm-gray flex flex-col flex-shrink-0 overflow-y-auto scrollbar-thin">
                <div class="p-4 border-b border-warm-gray">
                    <h3 class="font-semibold text-charcoal" data-i18n="config.title">é…ç½®</h3>
                </div>

                <div class="p-4 space-y-5">
                    <!-- é¢„è®¾è¯´è¯äººé…ç½® -->
                    <div id="config-preset" class="space-y-4">
                        <div>
                            <label class="block text-sm text-charcoal/70 mb-2" data-i18n="config.speaker">è¯´è¯äºº</label>
                            <select id="speaker" class="input-field">
                                <option value="vivian">Vivian (ä¸­æ–‡å¥³)</option>
                                <option value="uncle_fu">Uncle Fu (ä¸­æ–‡ç”·)</option>
                                <option value="aiden">Aiden (è‹±æ–‡ç”·)</option>
                                <option value="serena">Serena (è‹±æ–‡å¥³)</option>
                                <option value="ono_anna">Ono Anna (æ—¥è¯­å¥³)</option>
                                <option value="sohee">Sohee (éŸ©è¯­å¥³)</option>
                                <option value="dylan">Dylan (ç”·)</option>
                                <option value="eric">Eric (ç”·)</option>
                                <option value="ryan">Ryan (ç”·)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-charcoal/70 mb-2" data-i18n="config.language">è¯­è¨€</label>
                            <select id="language-preset" class="input-field">
                                <option value="Chinese">ä¸­æ–‡</option>
                                <option value="English">English</option>
                                <option value="Japanese">æ—¥æœ¬èª</option>
                                <option value="Korean">í•œêµ­ì–´</option>
                                <option value="German">Deutsch</option>
                                <option value="French">FranÃ§ais</option>
                                <option value="Russian">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                                <option value="Portuguese">PortuguÃªs</option>
                                <option value="Spanish">EspaÃ±ol</option>
                                <option value="Italian">Italiano</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-charcoal/70 mb-2" data-i18n="config.instruct">æƒ…æ„ŸæŒ‡ä»¤ <span class="text-charcoal/50">(å¯é€‰)</span></label>
                            <input type="text" id="instruct" class="input-field" data-i18n-placeholder="config.instructPlaceholder" placeholder="å¦‚ï¼šç”¨å¼€å¿ƒçš„è¯­æ°”è¯´">
                        </div>
                    </div>

                    <!-- è¯­éŸ³å…‹éš†é…ç½® -->
                    <div id="config-clone" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm text-charcoal/70 mb-2" data-i18n="config.language">è¯­è¨€</label>
                            <select id="language-clone" class="input-field">
                                <option value="Chinese">ä¸­æ–‡</option>
                                <option value="English">English</option>
                                <option value="Japanese">æ—¥æœ¬èª</option>
                                <option value="Korean">í•œêµ­ì–´</option>
                                <option value="German">Deutsch</option>
                                <option value="French">FranÃ§ais</option>
                                <option value="Russian">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                                <option value="Portuguese">PortuguÃªs</option>
                                <option value="Spanish">EspaÃ±ol</option>
                                <option value="Italian">Italiano</option>
                            </select>
                        </div>

                        <!-- éŸ³é¢‘æ¥æº -->
                        <div>
                            <label class="block text-sm text-charcoal/70 mb-2" data-i18n="config.refAudio">å‚è€ƒéŸ³é¢‘</label>
                            <div class="space-y-2">
                                <!-- å½•éŸ³æŒ‰é’® -->
                                <button id="record-btn" onclick="toggleRecording()" class="w-full flex items-center justify-center gap-2 py-3 bg-cream-dark border border-warm-gray rounded-lg hover:bg-warm-gray transition-colors">
                                    <span id="record-icon">ğŸ™ï¸</span>
                                    <span id="record-text" data-i18n="btn.record">å½•éŸ³</span>
                                    <span id="record-timer" class="hidden text-accent font-mono">00:00</span>
                                </button>
                                <!-- ä¸Šä¼ æŒ‰é’® -->
                                <label class="w-full flex items-center justify-center gap-2 py-3 bg-cream-dark border border-warm-gray rounded-lg hover:bg-warm-gray transition-colors cursor-pointer">
                                    <span>ğŸ“</span>
                                    <span data-i18n="btn.upload">ä¸Šä¼ æ–‡ä»¶</span>
                                    <input type="file" id="audio-file" accept="audio/*" class="hidden" onchange="handleFileSelect(this)">
                                </label>
                            </div>
                            <!-- éŸ³é¢‘é¢„è§ˆ -->
                            <div id="audio-preview-section" class="hidden mt-3 p-3 bg-cream-dark rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-charcoal/70" data-i18n="config.preview">éŸ³é¢‘é¢„è§ˆ</span>
                                    <button onclick="clearAudio()" class="text-charcoal/50 hover:text-red-600 text-sm">âœ•</button>
                                </div>
                                <audio id="audio-preview" controls class="w-full mt-2 h-8"></audio>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm text-charcoal/70 mb-2">
                                <span data-i18n="config.refText">å‚è€ƒæ–‡æœ¬</span>
                                <span class="text-charcoal/50" data-i18n="config.refTextHint">(å¯é€‰ï¼Œæé«˜è´¨é‡)</span>
                            </label>
                            <textarea id="ref-text" class="input-field h-20" data-i18n-placeholder="config.refTextPlaceholder" placeholder="å‚è€ƒéŸ³é¢‘çš„æ–‡å­—å†…å®¹"></textarea>
                        </div>

                        <!-- ä¿å­˜å£°éŸ³ -->
                        <div id="save-voice-section" class="hidden pt-4 border-t border-warm-gray">
                            <label class="block text-sm text-charcoal/70 mb-2" data-i18n="config.saveName">ä¿å­˜åˆ°å£°éŸ³åº“</label>
                            <div class="flex gap-2">
                                <input type="text" id="voice-name" class="input-field flex-1" data-i18n-placeholder="config.saveNamePlaceholder" placeholder="å£°éŸ³åç§°">
                                <button onclick="saveVoice()" class="px-4 py-2 bg-cream-dark border border-warm-gray rounded-lg hover:bg-warm-gray transition-colors text-sm" data-i18n="btn.save">ä¿å­˜</button>
                            </div>
                        </div>
                    </div>

                    <!-- å£°éŸ³è®¾è®¡é…ç½® -->
                    <div id="config-design" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm text-charcoal/70 mb-2" data-i18n="config.language">è¯­è¨€</label>
                            <select id="language-design" class="input-field">
                                <option value="Chinese">ä¸­æ–‡</option>
                                <option value="English">English</option>
                                <option value="Japanese">æ—¥æœ¬èª</option>
                                <option value="Korean">í•œêµ­ì–´</option>
                                <option value="German">Deutsch</option>
                                <option value="French">FranÃ§ais</option>
                                <option value="Russian">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                                <option value="Portuguese">PortuguÃªs</option>
                                <option value="Spanish">EspaÃ±ol</option>
                                <option value="Italian">Italiano</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-charcoal/70 mb-2" data-i18n="config.voiceDesc">å£°éŸ³æè¿° <span class="text-red-500">*</span></label>
                            <textarea id="voice-desc" class="input-field h-24" data-i18n-placeholder="config.voiceDescPlaceholder" placeholder="æè¿°ä½ æƒ³è¦çš„å£°éŸ³ï¼Œå¦‚ï¼šä½æ²‰æ²™å“‘çš„ä¸­å¹´ç”·å£°ï¼Œè¯­é€Ÿè¾ƒæ…¢"></textarea>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- API æ–‡æ¡£é¡µé¢ (è¦†ç›–å±‚) -->
    <div id="api-overlay" class="hidden fixed inset-0 bg-cream/95 z-50 overflow-y-auto">
        <div class="max-w-4xl mx-auto p-8">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-2xl font-bold text-charcoal" data-i18n="api.title">API æ–‡æ¡£</h1>
                <button onclick="showPage('main')" class="text-charcoal/50 hover:text-charcoal text-2xl">&times;</button>
            </div>

            <div class="space-y-6">
                <!-- é¢„è®¾è¯´è¯äºº API -->
                <div class="bg-white rounded-xl p-6 border border-warm-gray">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-charcoal">
                        <span>ğŸ¤</span>
                        <span data-i18n="api.presetTTS">é¢„è®¾è¯´è¯äºº TTS</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded">GET</span>
                            <code class="text-sm">/tts</code>
                        </div>
                        <pre class="bg-charcoal rounded-lg p-4 overflow-x-auto text-sm text-green-400"><code>curl "http://localhost:8000/tts?text=ä½ å¥½ä¸–ç•Œ&speaker=vivian&language=Chinese" -o output.wav</code></pre>
                    </div>
                </div>

                <!-- è¯­éŸ³å…‹éš† API -->
                <div class="bg-white rounded-xl p-6 border border-warm-gray">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-charcoal">
                        <span>ğŸ­</span>
                        <span data-i18n="api.cloneTTS">è¯­éŸ³å…‹éš†</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">POST</span>
                            <code class="text-sm">/clone</code>
                        </div>
                        <pre class="bg-charcoal rounded-lg p-4 overflow-x-auto text-sm text-green-400"><code>curl -X POST "http://localhost:8000/clone" \
  -F "audio=@reference.wav" \
  -F "text=ä½ å¥½ä¸–ç•Œ" \
  -F "language=Chinese" \
  -o output.wav</code></pre>
                    </div>
                </div>

                <!-- å£°éŸ³è®¾è®¡ API -->
                <div class="bg-white rounded-xl p-6 border border-warm-gray">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-charcoal">
                        <span>âœ¨</span>
                        <span data-i18n="api.designTTS">å£°éŸ³è®¾è®¡</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">POST</span>
                            <code class="text-sm">/design</code>
                        </div>
                        <pre class="bg-charcoal rounded-lg p-4 overflow-x-auto text-sm text-green-400"><code>curl -X POST "http://localhost:8000/design" \
  -F "text=ä½ å¥½ä¸–ç•Œ" \
  -F "language=Chinese" \
  -F "instruct=ä½æ²‰æ²™å“‘çš„ä¸­å¹´ç”·å£°" \
  -o output.wav</code></pre>
                    </div>
                </div>

                <!-- å£°éŸ³åº“ API -->
                <div class="bg-white rounded-xl p-6 border border-warm-gray">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-charcoal">
                        <span>ğŸ“š</span>
                        <span data-i18n="api.voiceLibrary">å£°éŸ³åº“ç®¡ç†</span>
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded">GET</span>
                                <code class="text-sm text-charcoal">/voices</code>
                                <span class="text-charcoal/50 text-sm">- è·å–å·²ä¿å­˜çš„å£°éŸ³åˆ—è¡¨</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">POST</span>
                                <code class="text-sm text-charcoal">/voices/save</code>
                                <span class="text-charcoal/50 text-sm">- ä¿å­˜å£°éŸ³</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">POST</span>
                                <code class="text-sm text-charcoal">/voices/{voice_id}/tts</code>
                                <span class="text-charcoal/50 text-sm">- ä½¿ç”¨å·²ä¿å­˜å£°éŸ³ç”Ÿæˆ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== çŠ¶æ€ç®¡ç† =====
        let currentMode = 'preset'; // preset, clone, design
        let currentLang = 'zh';
        let selectedVoiceId = null;
        let savedVoices = [];

        // å½•éŸ³ç›¸å…³
        let mediaRecorder = null;
        let audioChunks = [];
        let recordedBlob = null;
        let selectedFile = null;
        let recordingStartTime = null;
        let timerInterval = null;

        // éŸ³é¢‘æ’­æ”¾
        const audioElement = document.getElementById('audio-element');

        // ===== å›½é™…åŒ– =====
        const i18n = {
            zh: {
                'nav.preset': 'é¢„è®¾è¯´è¯äºº',
                'nav.clone': 'è¯­éŸ³å…‹éš†',
                'nav.design': 'å£°éŸ³è®¾è®¡',
                'nav.api': 'API æ–‡æ¡£',
                'main.title': 'æ–‡å­—è½¬è¯­éŸ³',
                'main.placeholder': 'åœ¨æ­¤è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬...',
                'config.title': 'é…ç½®',
                'config.speaker': 'è¯´è¯äºº',
                'config.language': 'è¯­è¨€',
                'config.instruct': 'æƒ…æ„ŸæŒ‡ä»¤',
                'config.instructPlaceholder': 'å¦‚ï¼šç”¨å¼€å¿ƒçš„è¯­æ°”è¯´',
                'config.refAudio': 'å‚è€ƒéŸ³é¢‘',
                'config.refText': 'å‚è€ƒæ–‡æœ¬',
                'config.refTextHint': '(å¯é€‰ï¼Œæé«˜è´¨é‡)',
                'config.refTextPlaceholder': 'å‚è€ƒéŸ³é¢‘çš„æ–‡å­—å†…å®¹',
                'config.preview': 'éŸ³é¢‘é¢„è§ˆ',
                'config.voiceDesc': 'å£°éŸ³æè¿°',
                'config.voiceDescPlaceholder': 'æè¿°ä½ æƒ³è¦çš„å£°éŸ³ï¼Œå¦‚ï¼šä½æ²‰æ²™å“‘çš„ä¸­å¹´ç”·å£°',
                'config.saveName': 'ä¿å­˜åˆ°å£°éŸ³åº“',
                'config.saveNamePlaceholder': 'å£°éŸ³åç§°',
                'clone.voiceLibrary': 'å£°éŸ³åº“',
                'btn.generate': 'ç”Ÿæˆè¯­éŸ³',
                'btn.record': 'å½•éŸ³',
                'btn.stopRecord': 'åœæ­¢',
                'btn.upload': 'ä¸Šä¼ æ–‡ä»¶',
                'btn.save': 'ä¿å­˜',
                'btn.stop': 'åœæ­¢',
                'stats.chars': 'å­—',
                'stats.sentences': 'å¥',
                'status.generating': 'ç”Ÿæˆä¸­...',
                'status.success': 'ç”ŸæˆæˆåŠŸ',
                'status.failed': 'ç”Ÿæˆå¤±è´¥',
                'status.stopped': 'å·²åœæ­¢',
                'status.enterText': 'è¯·è¾“å…¥æ–‡æœ¬',
                'status.needAudio': 'è¯·å½•éŸ³æˆ–ä¸Šä¼ å‚è€ƒéŸ³é¢‘',
                'status.needDesc': 'è¯·è¾“å…¥å£°éŸ³æè¿°',
                'status.modelLoading': 'æ¨¡å‹åŠ è½½ä¸­...',
                'status.saved': 'å·²ä¿å­˜',
                'status.saving': 'ä¿å­˜ä¸­...',
                'api.title': 'API æ–‡æ¡£',
                'api.presetTTS': 'é¢„è®¾è¯´è¯äºº TTS',
                'api.cloneTTS': 'è¯­éŸ³å…‹éš†',
                'api.designTTS': 'å£°éŸ³è®¾è®¡',
                'api.voiceLibrary': 'å£°éŸ³åº“ç®¡ç†',
                'confirm.delete': 'ç¡®å®šåˆ é™¤æ­¤å£°éŸ³ï¼Ÿ',
            },
            en: {
                'nav.preset': 'Preset Voices',
                'nav.clone': 'Voice Clone',
                'nav.design': 'Voice Design',
                'nav.api': 'API Docs',
                'main.title': 'Text to Speech',
                'main.placeholder': 'Enter text to convert...',
                'config.title': 'Settings',
                'config.speaker': 'Speaker',
                'config.language': 'Language',
                'config.instruct': 'Emotion',
                'config.instructPlaceholder': 'e.g., speak happily',
                'config.refAudio': 'Reference Audio',
                'config.refText': 'Reference Text',
                'config.refTextHint': '(optional)',
                'config.refTextPlaceholder': 'Transcript of reference audio',
                'config.preview': 'Preview',
                'config.voiceDesc': 'Voice Description',
                'config.voiceDescPlaceholder': 'Describe the voice you want',
                'config.saveName': 'Save to Library',
                'config.saveNamePlaceholder': 'Voice name',
                'clone.voiceLibrary': 'Voice Library',
                'btn.generate': 'Generate',
                'btn.record': 'Record',
                'btn.stopRecord': 'Stop',
                'btn.upload': 'Upload',
                'btn.save': 'Save',
                'btn.stop': 'Stop',
                'stats.chars': 'chars',
                'stats.sentences': 'sentences',
                'status.generating': 'Generating...',
                'status.success': 'Success',
                'status.failed': 'Failed',
                'status.stopped': 'Stopped',
                'status.enterText': 'Please enter text',
                'status.needAudio': 'Please record or upload audio',
                'status.needDesc': 'Please enter voice description',
                'status.modelLoading': 'Loading model...',
                'status.saved': 'Saved',
                'status.saving': 'Saving...',
                'api.title': 'API Documentation',
                'api.presetTTS': 'Preset Voice TTS',
                'api.cloneTTS': 'Voice Cloning',
                'api.designTTS': 'Voice Design',
                'api.voiceLibrary': 'Voice Library',
                'confirm.delete': 'Delete this voice?',
            }
        };

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function updateI18n() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.textContent = t(el.dataset.i18n);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                el.placeholder = t(el.dataset.i18nPlaceholder);
            });
            document.getElementById('lang-toggle').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­';
        }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            localStorage.setItem('lang', currentLang);
            updateI18n();
        }

        // ===== æ¨¡å¼åˆ‡æ¢ =====
        function switchMode(mode) {
            currentMode = mode;

            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.mode === mode);
            });

            // æ˜¾ç¤º/éšè—é…ç½®é¢æ¿
            document.getElementById('config-preset').classList.toggle('hidden', mode !== 'preset');
            document.getElementById('config-clone').classList.toggle('hidden', mode !== 'clone');
            document.getElementById('config-design').classList.toggle('hidden', mode !== 'design');

            // æ˜¾ç¤º/éšè—å£°éŸ³åº“
            document.getElementById('voice-library-section').classList.toggle('hidden', mode !== 'clone');

            // æ¸…é™¤é€‰ä¸­çš„å£°éŸ³
            if (mode !== 'clone') {
                selectedVoiceId = null;
            }

            // éšè—æ’­æ”¾å™¨
            document.getElementById('player-section').classList.add('hidden');
            document.getElementById('save-voice-section').classList.add('hidden');
        }

        // ===== é¡µé¢åˆ‡æ¢ =====
        function showPage(page) {
            document.getElementById('api-overlay').classList.toggle('hidden', page !== 'api');
        }

        // ===== å­—æ•°ç»Ÿè®¡ =====
        function updateCharCount() {
            const text = document.getElementById('text-input').value;
            document.getElementById('char-count').innerHTML = `${text.length} <span data-i18n="stats.chars">${t('stats.chars')}</span>`;

            // æ–‡æœ¬ä¸ºç©ºæ—¶ç¦ç”¨ç”ŸæˆæŒ‰é’®
            const btn = document.getElementById('generate-btn');
            if (!isGenerating) {
                btn.disabled = text.trim().length === 0;
            }
        }

        // ===== å£°éŸ³åº“ =====
        async function loadSavedVoices() {
            try {
                const response = await fetch('/voices');
                const data = await response.json();
                savedVoices = data.voices || [];
                renderVoiceList();
            } catch (error) {
                console.error('Failed to load voices:', error);
            }
        }

        // å£°éŸ³åº“é¢„è§ˆæ’­æ”¾å™¨
        let previewAudio = null;
        let previewingVoiceId = null;

        function renderVoiceList() {
            const container = document.getElementById('voice-list');
            if (savedVoices.length === 0) {
                container.innerHTML = `<div class="text-center text-charcoal/50 text-sm py-4">æš‚æ— ä¿å­˜çš„å£°éŸ³</div>`;
                return;
            }

            container.innerHTML = savedVoices.map(voice => `
                <div class="voice-card ${selectedVoiceId === voice.id ? 'selected' : ''}" onclick="selectVoice('${voice.id}')">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium truncate">${voice.name}</span>
                        <div class="flex gap-1">
                            <button id="preview-btn-${voice.id}" onclick="event.stopPropagation(); previewVoice('${voice.id}')" class="p-1 hover:bg-warm-gray rounded" title="é¢„è§ˆ">${previewingVoiceId === voice.id ? 'â¸' : 'â–¶'}</button>
                            <button onclick="event.stopPropagation(); deleteVoice('${voice.id}')" class="p-1 hover:bg-red-500/20 hover:text-red-600 rounded" title="åˆ é™¤">âœ•</button>
                        </div>
                    </div>
                    <div class="text-xs text-charcoal/50 mt-1">${voice.language}</div>
                </div>
            `).join('');
        }

        function selectVoice(voiceId) {
            selectedVoiceId = selectedVoiceId === voiceId ? null : voiceId;
            renderVoiceList();

            // é€‰ä¸­å£°éŸ³åº“æ—¶æ¸…é™¤å½•éŸ³/ä¸Šä¼ 
            if (selectedVoiceId) {
                clearAudio();
            }
        }

        function previewVoice(voiceId) {
            // å¦‚æœæ­£åœ¨æ’­æ”¾åŒä¸€ä¸ªå£°éŸ³ï¼Œåˆ™åœæ­¢
            if (previewingVoiceId === voiceId && previewAudio) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
                previewAudio = null;
                previewingVoiceId = null;
                renderVoiceList();
                return;
            }

            // å¦‚æœæ­£åœ¨æ’­æ”¾å…¶ä»–å£°éŸ³ï¼Œå…ˆåœæ­¢
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
            }

            // æ’­æ”¾æ–°å£°éŸ³
            previewAudio = new Audio(`/voices/${voiceId}/preview`);
            previewingVoiceId = voiceId;
            renderVoiceList();

            previewAudio.play();

            // æ’­æ”¾ç»“æŸåé‡ç½®çŠ¶æ€
            previewAudio.onended = () => {
                previewingVoiceId = null;
                previewAudio = null;
                renderVoiceList();
            };
        }

        async function deleteVoice(voiceId) {
            if (!confirm(t('confirm.delete'))) return;
            try {
                await fetch(`/voices/${voiceId}`, { method: 'DELETE' });
                if (selectedVoiceId === voiceId) selectedVoiceId = null;
                await loadSavedVoices();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function saveVoice() {
            const name = document.getElementById('voice-name').value.trim();
            if (!name) return;

            const language = document.getElementById('language-clone').value;
            const refText = document.getElementById('ref-text').value.trim();

            let audioFile = recordedBlob ? new File([recordedBlob], 'recording.webm', { type: 'audio/webm' }) : selectedFile;
            if (!audioFile) return;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('language', language);
            formData.append('ref_text', refText);
            formData.append('audio', audioFile);

            const statusEl = document.getElementById('status-message');
            statusEl.textContent = t('status.saving');

            try {
                const response = await fetch('/voices/save', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Save failed');
                statusEl.textContent = t('status.saved');
                document.getElementById('voice-name').value = '';
                await loadSavedVoices();
            } catch (error) {
                statusEl.textContent = t('status.failed') + ': ' + error.message;
            }
        }

        // ===== å½•éŸ³ =====
        async function toggleRecording() {
            const btn = document.getElementById('record-btn');
            const icon = document.getElementById('record-icon');
            const text = document.getElementById('record-text');
            const timer = document.getElementById('record-timer');

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => {
                        if (e.data.size > 0) audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        stream.getTracks().forEach(track => track.stop());
                        recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        selectedFile = null;

                        // å–æ¶ˆå£°éŸ³åº“é€‰ä¸­
                        if (selectedVoiceId) {
                            selectedVoiceId = null;
                            renderVoiceList();
                        }

                        showAudioPreview(URL.createObjectURL(recordedBlob));

                        icon.textContent = 'ğŸ™ï¸';
                        text.textContent = t('btn.record');
                        timer.classList.add('hidden');
                        btn.classList.remove('bg-red-500/20', 'border-red-500');
                        clearInterval(timerInterval);
                    };

                    mediaRecorder.start();
                    recordingStartTime = Date.now();

                    icon.innerHTML = '<div class="recording-indicator"></div>';
                    text.textContent = t('btn.stopRecord');
                    timer.classList.remove('hidden');
                    timer.textContent = '00:00';
                    btn.classList.add('bg-red-500/20', 'border-red-500');

                    timerInterval = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                        timer.textContent = `${String(Math.floor(elapsed / 60)).padStart(2, '0')}:${String(elapsed % 60).padStart(2, '0')}`;
                    }, 100);

                } catch (err) {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + err.message);
                }
            } else if (mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                selectedFile = file;
                recordedBlob = null;

                // å–æ¶ˆå£°éŸ³åº“é€‰ä¸­
                if (selectedVoiceId) {
                    selectedVoiceId = null;
                    renderVoiceList();
                }

                showAudioPreview(URL.createObjectURL(file));
            }
        }

        function showAudioPreview(url) {
            document.getElementById('audio-preview-section').classList.remove('hidden');
            document.getElementById('audio-preview').src = url;
        }

        function clearAudio() {
            recordedBlob = null;
            selectedFile = null;
            document.getElementById('audio-preview-section').classList.add('hidden');
            document.getElementById('audio-preview').src = '';
            document.getElementById('audio-file').value = '';
        }

        // ===== ç”Ÿæˆè¯­éŸ³ =====

        // åˆ†å¥è¿›åº¦ç”Ÿæˆ
        let currentEventSource = null;
        let isGenerating = false;

        function stopGeneration() {
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            isGenerating = false;
            // éšè—è¿›åº¦è§†å›¾
            const textInput = document.getElementById('text-input');
            const progressView = document.getElementById('progress-view');
            textInput.classList.remove('hidden');
            progressView.classList.add('hidden');

            const btn = document.getElementById('generate-btn');
            const statusEl = document.getElementById('status-message');
            btn.disabled = false;
            btn.onclick = generate;
            btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>${t('btn.generate')}</span>`;
            statusEl.innerHTML = `<span class="text-yellow-600">${t('status.stopped')}</span>`;
            updateCharCount();
        }

        // å‰ç«¯åˆ†å¥ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰
        function splitTextToSentences(text, minLength = 10) {
            const pattern = /([ã€‚ï¼ï¼Ÿï¼›.!?;]+|\n)/;
            const parts = text.split(pattern);

            const rawSentences = [];
            let current = '';
            for (const part of parts) {
                current += part;
                if (pattern.test(part)) {
                    if (current.trim()) {
                        rawSentences.push(current.trim());
                    }
                    current = '';
                }
            }
            if (current.trim()) {
                rawSentences.push(current.trim());
            }

            if (rawSentences.length === 0) {
                return text.trim() ? [text] : [];
            }

            // åˆå¹¶è¿‡çŸ­çš„å¥å­
            const merged = [];
            let buffer = '';
            for (const sentence of rawSentences) {
                buffer += sentence;
                if (buffer.length >= minLength) {
                    merged.push(buffer);
                    buffer = '';
                }
            }
            if (buffer) {
                if (merged.length > 0) {
                    merged[merged.length - 1] += buffer;
                } else {
                    merged.push(buffer);
                }
            }
            return merged;
        }

        // æ˜¾ç¤ºè¿›åº¦è§†å›¾
        function showProgressView(sentences) {
            const textInput = document.getElementById('text-input');
            const progressView = document.getElementById('progress-view');

            // æ„å»ºå¸¦æ ·å¼çš„å¥å­åˆ—è¡¨
            let html = '';
            sentences.forEach((sentence, index) => {
                html += `<span id="sentence-${index}" class="sentence-pending">${escapeHtml(sentence)}</span>`;
            });

            progressView.innerHTML = html;
            textInput.classList.add('hidden');
            progressView.classList.remove('hidden');
        }

        // æ›´æ–°å¥å­è¿›åº¦æ ·å¼
        function updateSentenceProgress(current) {
            // current æ˜¯å·²å®Œæˆçš„æ•°é‡ï¼ˆ1-basedï¼‰
            for (let i = 0; i < current; i++) {
                const el = document.getElementById(`sentence-${i}`);
                if (el) {
                    el.className = 'sentence-done';
                }
            }
            // æ ‡è®°æ­£åœ¨ç”Ÿæˆçš„å¥å­
            const currentEl = document.getElementById(`sentence-${current}`);
            if (currentEl) {
                currentEl.className = 'sentence-current';
            }
        }

        // éšè—è¿›åº¦è§†å›¾
        function hideProgressView() {
            const textInput = document.getElementById('text-input');
            const progressView = document.getElementById('progress-view');
            textInput.classList.remove('hidden');
            progressView.classList.add('hidden');
            updateCharCount();
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function generateWithProgress(url, btn, statusEl) {
            isGenerating = true;

            // è·å–æ–‡æœ¬å¹¶åˆ†å¥æ˜¾ç¤º
            const text = document.getElementById('text-input').value.trim();
            const sentences = splitTextToSentences(text);
            showProgressView(sentences);

            return new Promise((resolve, reject) => {
                const eventSource = new EventSource(url);
                currentEventSource = eventSource;
                let totalSentences = 0;

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.started) {
                            totalSentences = data.total;
                            statusEl.textContent = `${t('status.generating')} 0/${totalSentences} ${t('stats.sentences')} (0%)`;
                            // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
                            btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12"></rect></svg><span>${t('btn.stop')}</span>`;
                            btn.disabled = false;
                            btn.onclick = stopGeneration;
                            // æ ‡è®°ç¬¬ä¸€å¥æ­£åœ¨ç”Ÿæˆ
                            updateSentenceProgress(0);
                        }

                        if (data.progress) {
                            const { current, total, percent } = data.progress;
                            btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12"></rect></svg><span>${current}/${total} ${t('stats.sentences')} (${percent}%)</span>`;
                            statusEl.textContent = `${t('status.generating')} ${current}/${total} ${t('stats.sentences')} (${percent}%)`;
                            // æ›´æ–°å¥å­æ ·å¼
                            updateSentenceProgress(current);
                        }

                        if (data.done) {
                            eventSource.close();
                            currentEventSource = null;
                            isGenerating = false;
                            hideProgressView();

                            // å°† base64 è½¬ä¸º blob URL
                            const binaryString = atob(data.audio);
                            const bytes = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            const blob = new Blob([bytes], { type: 'audio/wav' });
                            const audioUrl = URL.createObjectURL(blob);

                            // æ¢å¤æŒ‰é’®
                            btn.onclick = generate;
                            resolve({
                                audioUrl,
                                stats: data.stats,
                            });
                        }

                        if (data.error) {
                            eventSource.close();
                            currentEventSource = null;
                            isGenerating = false;
                            hideProgressView();
                            btn.onclick = generate;
                            reject(new Error(data.error));
                        }
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                };

                eventSource.onerror = (error) => {
                    eventSource.close();
                    currentEventSource = null;
                    isGenerating = false;
                    hideProgressView();
                    btn.onclick = generate;
                    reject(new Error(t('status.failed')));
                };
            }).catch((error) => {
                hideProgressView();
                statusEl.innerHTML = `<span class="text-red-600">${t('status.failed')}: ${error.message}</span>`;
                btn.disabled = false;
                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>${t('btn.generate')}</span>`;
                return null;
            });
        }

        async function generate() {
            const text = document.getElementById('text-input').value.trim();
            const btn = document.getElementById('generate-btn');
            const statusEl = document.getElementById('status-message');

            if (!text) {
                statusEl.textContent = t('status.enterText');
                return;
            }

            // éªŒè¯å…‹éš†æ¨¡å¼
            if (currentMode === 'clone' && !selectedVoiceId && !recordedBlob && !selectedFile) {
                statusEl.textContent = t('status.needAudio');
                return;
            }

            // éªŒè¯å£°éŸ³è®¾è®¡æ¨¡å¼
            if (currentMode === 'design') {
                const desc = document.getElementById('voice-desc').value.trim();
                if (!desc) {
                    statusEl.textContent = t('status.needDesc');
                    return;
                }
            }

            btn.disabled = true;
            btn.innerHTML = `<span class="spinner"></span><span>${t('status.generating')}</span>`;
            statusEl.textContent = '';

            // ç¡®ä¿æ¨¡å‹åŠ è½½
            const modelType = currentMode === 'preset' ? 'custom' : currentMode;
            const modelReady = await ensureModelLoaded(modelType);
            if (!modelReady) {
                btn.disabled = false;
                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>${t('btn.generate')}</span>`;
                return;
            }

            try {
                let response;
                let stats = null;

                if (currentMode === 'preset') {
                    const speaker = document.getElementById('speaker').value;
                    const language = document.getElementById('language-preset').value;
                    const instruct = document.getElementById('instruct').value.trim();

                    // ä½¿ç”¨åˆ†å¥è¿›åº¦ç”Ÿæˆ
                    const params = new URLSearchParams({ text, speaker, language });
                    if (instruct) params.append('instruct', instruct);

                    const result = await generateWithProgress(`/tts/progress?${params.toString()}`, btn, statusEl);
                    if (!result) return;

                    audioElement.src = result.audioUrl;
                    stats = result.stats;

                    // è·³è¿‡åé¢çš„ response å¤„ç†
                    audioElement.play();
                    document.getElementById('player-section').classList.remove('hidden');

                    if (stats) {
                        document.getElementById('stats-chars').textContent = `${stats.char_count} ${t('stats.chars')} Â· ${stats.sentence_count} ${t('stats.sentences')} Â· ${stats.elapsed}s`;
                        document.getElementById('stats-speed').textContent = `${stats.avg_per_char}s/${t('stats.chars')}`;
                    }

                    statusEl.innerHTML = `<span class="text-green-600">${t('status.success')}</span>`;
                    document.getElementById('save-voice-section').classList.add('hidden');

                    btn.disabled = false;
                    btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>${t('btn.generate')}</span>`;
                    return;

                } else if (currentMode === 'clone') {
                    const language = document.getElementById('language-clone').value;
                    const refText = document.getElementById('ref-text').value.trim();

                    if (selectedVoiceId) {
                        // ä½¿ç”¨å£°éŸ³åº“çš„åˆ†å¥è¿›åº¦ç”Ÿæˆ
                        const params = new URLSearchParams({ text });
                        if (language) params.append('language', language);

                        const result = await generateWithProgress(`/voices/${selectedVoiceId}/tts/progress?${params.toString()}`, btn, statusEl);
                        if (!result) return;

                        audioElement.src = result.audioUrl;
                        stats = result.stats;

                        audioElement.play();
                        document.getElementById('player-section').classList.remove('hidden');

                        if (stats) {
                            document.getElementById('stats-chars').textContent = `${stats.char_count} ${t('stats.chars')} Â· ${stats.sentence_count} ${t('stats.sentences')} Â· ${stats.elapsed}s`;
                            document.getElementById('stats-speed').textContent = `${stats.avg_per_char}s/${t('stats.chars')}`;
                        }

                        statusEl.innerHTML = `<span class="text-green-600">${t('status.success')}</span>`;
                        document.getElementById('save-voice-section').classList.add('hidden');

                        btn.disabled = false;
                        btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>${t('btn.generate')}</span>`;
                        return;
                    } else {
                        const audioFile = recordedBlob ? new File([recordedBlob], 'recording.webm', { type: 'audio/webm' }) : selectedFile;
                        const formData = new FormData();
                        formData.append('audio', audioFile);
                        formData.append('text', text);
                        formData.append('language', language);
                        formData.append('ref_text', refText);
                        response = await fetch('/clone', { method: 'POST', body: formData });
                    }

                } else if (currentMode === 'design') {
                    const language = document.getElementById('language-design').value;
                    const desc = document.getElementById('voice-desc').value.trim();

                    // ä½¿ç”¨å£°éŸ³è®¾è®¡çš„åˆ†å¥è¿›åº¦ç”Ÿæˆ
                    const params = new URLSearchParams({ text, language, instruct: desc });

                    const result = await generateWithProgress(`/design/progress?${params.toString()}`, btn, statusEl);
                    if (!result) return;

                    audioElement.src = result.audioUrl;
                    stats = result.stats;

                    audioElement.play();
                    document.getElementById('player-section').classList.remove('hidden');

                    if (stats) {
                        document.getElementById('stats-chars').textContent = `${stats.char_count} ${t('stats.chars')} Â· ${stats.sentence_count} ${t('stats.sentences')} Â· ${stats.elapsed}s`;
                        document.getElementById('stats-speed').textContent = `${stats.avg_per_char}s/${t('stats.chars')}`;
                    }

                    statusEl.innerHTML = `<span class="text-green-600">${t('status.success')}</span>`;
                    document.getElementById('save-voice-section').classList.add('hidden');

                    btn.disabled = false;
                    btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>${t('btn.generate')}</span>`;
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || t('status.failed'));
                }

                // æ’­æ”¾éŸ³é¢‘
                const blob = await response.blob();
                audioElement.src = URL.createObjectURL(blob);
                audioElement.play();

                // æ˜¾ç¤ºæ’­æ”¾å™¨
                document.getElementById('player-section').classList.remove('hidden');

                // æ˜¾ç¤ºç»Ÿè®¡
                const charCount = response.headers.get('X-Char-Count');
                const elapsed = response.headers.get('X-Elapsed');
                const avgPerChar = response.headers.get('X-Avg-Per-Char');

                if (charCount && elapsed) {
                    document.getElementById('stats-chars').textContent = `${charCount} ${t('stats.chars')} Â· ${elapsed}s`;
                    document.getElementById('stats-speed').textContent = `${avgPerChar}s/${t('stats.chars')}`;
                }

                statusEl.innerHTML = `<span class="text-green-600">${t('status.success')}</span>`;

                // å…‹éš†æ¨¡å¼æ˜¾ç¤ºä¿å­˜é€‰é¡¹ï¼ˆä»…éå£°éŸ³åº“ï¼‰
                if (currentMode === 'clone' && !selectedVoiceId) {
                    document.getElementById('save-voice-section').classList.remove('hidden');
                } else {
                    document.getElementById('save-voice-section').classList.add('hidden');
                }

            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-600">${t('status.failed')}: ${error.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>${t('btn.generate')}</span>`;
            }
        }

        async function ensureModelLoaded(modelType) {
            const statusEl = document.getElementById('status-message');

            try {
                const statusRes = await fetch('/model/status');
                const statusData = await statusRes.json();

                if (statusData.status[modelType] === 'loaded') {
                    return true;
                }

                if (statusData.status[modelType] === 'unloaded') {
                    statusEl.textContent = t('status.modelLoading');
                    await fetch(`/model/load/${modelType}`, { method: 'POST' });
                }

                // ç­‰å¾…åŠ è½½å®Œæˆ
                for (let i = 0; i < 120; i++) {
                    await new Promise(r => setTimeout(r, 1000));
                    const res = await fetch('/model/status');
                    const data = await res.json();
                    if (data.status[modelType] === 'loaded') {
                        statusEl.textContent = '';
                        return true;
                    }
                    if (data.status[modelType] === 'unloaded') {
                        statusEl.textContent = t('status.failed');
                        return false;
                    }
                }

                statusEl.textContent = t('status.failed');
                return false;

            } catch (error) {
                statusEl.textContent = t('status.failed') + ': ' + error.message;
                return false;
            }
        }

        // ===== éŸ³é¢‘æ’­æ”¾æ§åˆ¶ =====
        function togglePlay() {
            if (audioElement.paused) {
                audioElement.play();
            } else {
                audioElement.pause();
            }
        }

        function seek(event) {
            const bar = event.currentTarget;
            const rect = bar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioElement.currentTime = percent * audioElement.duration;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function downloadAudio() {
            if (!audioElement.src) return;

            const a = document.createElement('a');
            a.href = audioElement.src;
            a.download = `tts_${Date.now()}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        audioElement.addEventListener('timeupdate', () => {
            const progress = (audioElement.currentTime / audioElement.duration) * 100 || 0;
            document.getElementById('progress').style.width = `${progress}%`;
            document.getElementById('current-time').textContent = formatTime(audioElement.currentTime);
        });

        audioElement.addEventListener('loadedmetadata', () => {
            document.getElementById('duration').textContent = formatTime(audioElement.duration);
        });

        audioElement.addEventListener('play', () => {
            document.getElementById('play-icon').innerHTML = '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>';
        });

        audioElement.addEventListener('pause', () => {
            document.getElementById('play-icon').innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>';
        });

        audioElement.addEventListener('ended', () => {
            document.getElementById('play-icon').innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>';
        });

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', () => {
            currentLang = localStorage.getItem('lang') || 'zh';
            updateI18n();
            loadSavedVoices();
            updateCharCount();
        });
    </script>
</body>
</html>
